# Basic Usages

## `Rule`

### What a `Rule` Looks Like

```makefile
target ... : prerequisites ...
	recipe
	...
	...
```

* target: the file generated by some program, or an action to carry out(Phony Targets).

* prerequisite: the file used as input to create the target.

* recipe: action that makes carries out.

  Tab character at the beginning of every recipe line is required.

  Use '\\' to split one-line command to multiple lines.



### Use Rules to Build a Simple Executable File

An example:

```makefile
edit : main.o kbd.o command.o display.o \
       insert.o search.o files.o utils.o
        cc -o edit main.o kbd.o command.o display.o \
                   insert.o search.o files.o utils.o

main.o : main.c defs.h
        cc -c main.c
kbd.o : kbd.c defs.h command.h
        cc -c kbd.c
command.o : command.c defs.h command.h
        cc -c command.c
display.o : display.c defs.h buffer.h
        cc -c display.c
insert.o : insert.c defs.h buffer.h
        cc -c insert.c
search.o : search.c defs.h buffer.h
        cc -c search.c
files.o : files.c defs.h buffer.h command.h
        cc -c files.c
utils.o : utils.c defs.h
        cc -c utils.c
clean :
        rm edit main.o kbd.o command.o display.o \
           insert.o search.o files.o utils.o
```

Type `make` will create the executable file called edit.

Type `make clean` will delete the executable file and all the object files, which is what `clean` rule does.

When a target is a file, it needs to be recompiled or relinked if any of its prerequisites change. **Note:** if `main.c` is changed, `edit` will be recompiled.

`clean` is not the prerequisite, and has no prerequisite. 



### How `make` Processes a Makefile

By default, `make` starts with the first target (not targets whose names start with ‘.’). This is called the `default goal`. We can use command line or `.DEFAULT_GOAL` to change the default goal.

`Goals` are the targets that `make `strives ultimately to update.

The rules will check if all the prerequisites are the newest, by checking the prerequisites of every prerequisite recursively.



## `Variable`

### `Variables` Make Makefiles Simpler

We can use `Variables` to simplify rules. For example:

```makefile
edit : main.o kbd.o command.o display.o \
              insert.o search.o files.o utils.o
        cc -o edit main.o kbd.o command.o display.o \
                   insert.o search.o files.o utils.o
```

This is error-prone for duplication of '.o' files. We can use `variable` to eliminate the risk:

```makefile
objects = main.o kbd.o command.o display.o \
          insert.o search.o files.o utils.o

edit : $(objects)
	cc -o edit $(objects)
... # some .o rules
.PHONY : clean # prevents make from getting confused by an actual file called clean
clean : 
	rm edit $(objects)
```



Read the [website](https://www.gnu.org/software/make/manual/html_node/Flavors.html#Flavors) to understand the difference of `:=` and `=`.



## Splitting Long Lines

**Outside of recipe lines,** we can use backslash to split a logical line to multiple physical lines. When doing this, the whitespaces around backslash and the backslash itself will be considered as one whitespace.

If `.POSIX` special target is defined, some other things would happened, which we will not talk about now.

To avoid adding whitespace, we can use `$\` to split a word. For example:

```makefile
var := one$\
		word
# equivalent
var := oneword
```



```makefile
END: 3.3 Including Other Makefiles
```





# Some skills

## Passing Arguments to Target

For example, to passing 'abc' to main executable file:

```makefile
# Makefile :
ARGS = default value  # if command invoked without setting ARGS
run : main
	./main $(ARGS)
# command line
make run ARGS="abc"
```



## use static pattern

```makefile
%.o : %.c
	gcc -c $< -o $@
```



## mute command

Add `@` behind command can run the command mutely.



## colored text output

You can output colored text by `echo` in Makefile. Info can do same but more difficultly.

```makefile
runCmd = $(env) $(pyFiles)
run :
	@echo "\033[0;36m$(runCmd)\033[0m"
	@$(runCmd)
```





# Examples

```makefile
FILES = test
OBJS = $(addsuffix .o, $(FILES)) 
DISS = $(addsuffix .d, $(FILES))
ALL_GEN_FILES = $(OBJS) $(DISS) main
CFLAGS ?= -Wall -Werror -g -Og

main : $(OBJS)
	gcc $(OBJS) $(CFLAGS) -o main
    
%.o : %.c
	gcc -c $(CFLAGS) $< -o $@

%.d : %.o
	objdump -d $< > $@

.PHONY : clean ass gdb run
clean :
	rm -f $(ALL_GEN_FILES)

run : main
	./main

gdb : main
	gdb ./main

ass : $(DISS) 
```





